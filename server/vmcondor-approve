#!/bin/sh

if [ "$1" = "" -o "$2" = "" ] ; then
  echo vmcondor-approve USERNAME EMAIL@ADDRESS
  exit 0
fi

if [ -s "/var/lib/vmcondor-ca/approved/$1" ] ; then
  echo "/var/lib/vmcondor-ca/approved/$1 already exists!"
  exit 1
fi

if [ ! -s "/var/lib/vmcondor-ca/incoming/$1" ] ; then
  echo "/var/lib/vmcondor-ca/incoming/$1 does not exist!"
  exit 1
fi

(

  echo "EMAIL=$2"
  cat "/var/lib/vmcondor-ca/incoming/$1"

) > "/var/lib/vmcondor-ca/approved/$1"

newUID=1`echo "$1" | cut -c5-8`

useradd --home-dir /var/lib/condor --comment "VMCondor $1" --no-create-home --shell /sbin/nologin --uid $newUID  "$1"

(
  cd /var/lib/vmcondor-ca/approved

  echo '# DO NOT EDIT - CREATED BY vmcondor-approve'
  echo 'GSI "/C=UK/O=eScience/OU=Manchester/L=HEP/CN=iris-vm.blackett.manchester.ac.uk" condor'
  echo 'GSI "/C=UK/O=eScience/OU=Manchester/L=HEP/CN=andrew mcnab" condor'

  for username in *
  do
    echo 'GSI "/O=vmcondor.iris.ac.uk/CN='${username}'" '${username}
  done
) > /etc/condor/certificate_mapfile.tmp

mv -f /etc/condor/certificate_mapfile.tmp /etc/condor/certificate_mapfile

condor_reconfig -all

